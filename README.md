# Smart Chessboard - Micropython

## Introduction

This is a micropython project for the ESP32. It is a chessboard with a sensors that sense the position of the pieces. It is an embedded system project.

It uses API endpoints to communicate with the server, sending the position of the pieces and receiving the moves to be made. The moves are generated by stockfish, a chess engine. 

## Hardware

- ESP32
- PCB boards
  - [Controller](https://github.com/shuki25/smart-chessboard-controller)
  - [Chess clock](https://github.com/shuki25/smart-chessboard-clock)
  - [Chessboard](https://github.com/shuki25/smart-chessboard-board)

## Software

- Micropython
- Stockfish
- API endpoints

## Miscellanous
- [3D printed case]()
- [Glass Chessboard - 10"](https://www.amazon.com/gp/product/B019G5DLZU/)
- [Magnetic Chess Pieces](https://www.amazon.com/gp/product/B08MF1YBXP/)

## Python dependencies
Install the following python dependencies necessary to upload the code to the ESP32:
```bash
pip install -r requirements.txt
```

## Installing Micropython on ESP32

- Download the latest version of nightly builds Micropython firmware (fixes a particular bug that the chess program depends on) from [here](https://micropython.org/download/esp32/).
- Download the latest version of esptool from [here](https://github.com/espressif/esptool)

Program your board using the esptool.py program, found here.

If you are putting MicroPython on ESP32 for the first time then you would first erase the entire flash using:

```bash
esptool.py --chip esp32 --port /dev/cu.usbserial-0001 erase_flash
```

From then on program the firmware starting at address 0x1000:
```bash
esptool.py --chip esp32 --port /dev/cu.usbserial-0001 --baud 460800 write_flash -z 0x1000 <es>.bin
```

## Bytecode compilation
Due to large size of the chess program, it is necessary to compile them into bytecode and stored in the `bytecode-complied` folder. The repository includes bytecode compiled scripts to be uploaded to micropython.  If you are modifying some of the scripts, you would need to re-compile the scripts by running a script in the `src` folder.  The script will compile all the scripts in the `src` folder and store them in the `bytecode-complied` folder.  The script is `compile-project`.  To run the script, run the following command:
```bash
cd src
./compile-project
```

## Installing this project

- Clone this repository to your computer
- Install Thonny IDE
- Copy the files in the `bytecode-compiled` folder to the ESP32 board
- Connect your ESP32 to WiFi to be able to install the dependencies
- Install dependecies using `mip` after dropping into the `micropython` interactive shell (REPL)

```ipython
>>> import network
>>> sta_if = network.WLAN(network.STA_IF)
>>> sta_if.active(True)
>>> sta_if.connect('your-ssid', 'your-password')
>>> sta_if.isconnected()
>>> import mip
>>> mip.install("ssd1306")
```
After installing the dependencies, you can upload the files in the `bytecode-compiled` folder to the ESP32 board via Thonny IDE or other tools. The files in the `bytecode-compiled` folder are the compiled scripts that are ready to be uploaded to the ESP32 board. However, the scripts `boot.py` and `main.py` are not compiled.  They are the scripts that are executed when the ESP32 board is powered on.  The `boot.py` script is executed first and the `main.py` script is executed after the `boot.py` script is executed.  The `boot.py` script is responsible for the ESP32 startup and the `main.py` script is responsible for loading and running the chess program.

## Installing the Nextion display firmware

### Two ways to install the Nextion display firmware
1. Using the Nextion Editor
- Download the latest version of the [Nextion Editor](https://nextion.tech/download/)
- Upload the `smart-chessboard.tft` file to the Nextion display using the Nextion Editor software

2. Using the Nextion Uploader